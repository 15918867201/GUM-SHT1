# 代理服务器测试用例

## 1. CORS支持测试

### 1.1 响应头验证
- **测试目的**：验证代理服务器是否正确设置CORS头
- **测试方法**：发送OPTIONS请求到代理服务器
- **请求URL**：`https://apolonia-seminomadic-yvone.ngrok-free.dev/api/huacore.forms/documentapi/getvalue`
- **请求方法**：OPTIONS
- **请求头**：
  ```
  Origin: https://example.com
  Access-Control-Request-Method: POST
  Access-Control-Request-Headers: Content-Type
  ```
- **预期结果**：
  - HTTP状态码：200
  - 响应头包含：
    ```
    Access-Control-Allow-Origin: *
    Access-Control-Allow-Methods: GET, POST, OPTIONS
    Access-Control-Allow-Headers: Content-Type
    ```

### 1.2 跨域请求测试
- **测试目的**：验证来自不同域的客户端能够访问API
- **测试方法**：使用不同来源的请求测试API访问
- **测试步骤**：
  1. 从域A发送POST请求到API
  2. 从域B发送POST请求到API
  3. 检查响应是否成功
- **预期结果**：
  - 所有跨域请求都能成功完成
  - 响应头包含`Access-Control-Allow-Origin: *`

## 2. 请求转发测试

### 2.1 基本POST请求转发
- **测试目的**：验证代理服务器能够正确转发POST请求到内部API
- **请求URL**：`https://apolonia-seminomadic-yvone.ngrok-free.dev/api/huacore.forms/documentapi/getvalue`
- **请求方法**：POST
- **请求头**：
  ```
  Content-Type: application/json
  ngrok-skip-browser-warning: 1
  ```
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200,  // 2024-01-01 00:00:00
    "end_datetime": 1704153599    // 2024-01-01 23:59:59
  }
  ```
- **预期结果**：
  - HTTP状态码：200
  - 返回与直接请求内部API相同的数据
  - 响应格式与内部API一致

### 2.2 请求参数完整性
- **测试目的**：验证代理服务器能够完整转发请求参数
- **测试步骤**：
  1. 发送包含多个参数的请求
  2. 检查内部API是否收到完整参数
- **预期结果**：内部API收到的参数与客户端发送的参数完全一致

### 2.3 响应完整性
- **测试目的**：验证代理服务器能够完整转发内部API的响应
- **测试步骤**：
  1. 发送请求到代理服务器
  2. 对比代理服务器响应与直接请求内部API的响应
- **预期结果**：代理服务器的响应与内部API的响应完全一致

## 3. 错误处理测试

### 3.1 内部API不可达
- **测试目的**：验证代理服务器对内部API不可达情况的处理
- **测试方法**：模拟内部API服务器故障
- **预期结果**：
  - HTTP状态码：500
  - 响应体包含错误信息：`{"error": "<具体错误信息>"}`
  - 错误信息清晰描述了问题

### 3.2 无效请求格式
- **测试目的**：验证代理服务器对无效请求格式的处理
- **测试方法**：发送格式错误的JSON请求
- **请求体**：（缺少闭合引号）
  ```
  {
    "start_datetime": 1704067200,
    "end_datetime": 1704153599
  ```
- **预期结果**：
  - HTTP状态码：500
  - 响应体包含错误信息

### 3.3 内部API错误响应
- **测试目的**：验证代理服务器对内部API错误响应的处理
- **测试方法**：发送导致内部API错误的请求
- **预期结果**：
  - 代理服务器返回内部API的错误响应
  - 错误信息和状态码保持不变

## 4. 内网穿透功能测试

### 4.1 ngrok隧道连通性
- **测试目的**：验证ngrok隧道是否正常工作
- **测试方法**：发送请求到ngrok公网URL
- **预期结果**：
  - 请求能够成功到达内网代理服务器
  - 代理服务器能够处理请求并返回响应

### 4.2 请求头处理
- **测试目的**：验证代理服务器对ngrok特定请求头的处理
- **测试方法**：发送包含`ngrok-skip-browser-warning`头的请求
- **预期结果**：
  - 请求头被正确传递或处理
  - 浏览器不会显示ngrok警告页面

### 4.3 响应延迟测试
- **测试目的**：验证内网穿透的响应延迟
- **测试方法**：比较直接请求内网代理和通过ngrok请求的响应时间
- **预期结果**：
  - 通过ngrok请求的响应延迟增加在可接受范围内（通常<500ms）
  - 响应延迟稳定，无大幅波动

## 5. 代理服务器配置测试

### 5.1 监听地址和端口
- **测试目的**：验证代理服务器是否监听所有网络接口
- **测试方法**：从不同网络接口访问代理服务器
- **预期结果**：
  - 代理服务器能够从所有网络接口接收请求
  - 端口5000上的请求能够被正确处理

### 5.2 调试模式
- **测试目的**：验证代理服务器的调试模式设置
- **测试方法**：检查代理服务器的运行模式
- **预期结果**：
  - 生产环境下调试模式关闭（`debug=False`）
  - 代理服务器运行稳定，无额外调试输出

## 6. 性能测试

### 6.1 响应时间测试
- **测试目的**：验证代理服务器的响应时间
- **测试方法**：多次发送请求，测量响应时间
- **预期结果**：
  - 代理服务器的平均响应时间<1秒
  - 95%响应时间<2秒

### 6.2 并发请求测试
- **测试目的**：验证代理服务器在高并发情况下的稳定性
- **测试方法**：模拟多个并发请求
- **预期结果**：
  - 代理服务器能够处理10个以上的并发请求
  - 高并发下响应时间没有显著增加
  - 没有请求失败

### 6.3 长时间运行测试
- **测试目的**：验证代理服务器长时间运行的稳定性
- **测试方法**：持续运行代理服务器24小时，期间定期发送请求
- **预期结果**：
  - 代理服务器稳定运行，无内存泄漏
  - 响应时间保持稳定
  - 没有崩溃或异常退出

## 7. 安全测试

### 7.1 HTTPS传输验证
- **测试目的**：验证数据传输是否通过HTTPS加密
- **测试方法**：检查ngrok URL是否使用HTTPS协议
- **预期结果**：
  - 所有API请求使用HTTPS协议
  - 浏览器显示安全连接标志

### 7.2 请求体加密
- **测试目的**：验证请求体内容是否加密传输
- **测试方法**：使用网络抓包工具捕获请求
- **预期结果**：
  - 请求体内容在传输过程中是加密的
  - 无法直接读取请求参数

### 7.3 防火墙兼容性
- **测试目的**：验证代理服务器在不同防火墙环境下的兼容性
- **测试方法**：在不同防火墙配置下测试API访问
- **预期结果**：
  - 代理服务器能够在常见防火墙环境下工作
  - 只需要开放必要的端口（通常是80和443）

## 8. 内部API集成测试

### 8.1 数据一致性验证
- **测试目的**：验证通过代理服务器获取的数据与直接从内部API获取的数据一致
- **测试方法**：
  1. 直接请求内部API获取数据
  2. 通过代理服务器请求相同数据
  3. 对比两组数据
- **预期结果**：
  - 两组数据完全一致
  - 没有数据丢失或错误

### 8.2 内部API状态监控
- **测试目的**：验证代理服务器能够正确反映内部API的状态
- **测试方法**：
  1. 监控内部API的运行状态
  2. 当内部API可用时，测试代理服务器的响应
  3. 当内部API不可用时，测试代理服务器的响应
- **预期结果**：
  - 内部API可用时，代理服务器返回正常响应
  - 内部API不可用时，代理服务器返回适当的错误信息

## 9. 错误恢复测试

### 9.1 网络中断恢复
- **测试目的**：验证代理服务器在网络中断后的恢复能力
- **测试方法**：
  1. 断开内部API与代理服务器的网络连接
  2. 发送请求，验证错误响应
  3. 恢复网络连接
  4. 再次发送请求，验证正常响应
- **预期结果**：
  - 网络中断时，代理服务器返回错误信息
  - 网络恢复后，代理服务器能够正常处理请求

### 9.2 内部API重启恢复
- **测试目的**：验证代理服务器在内部API重启后的恢复能力
- **测试方法**：
  1. 重启内部API服务器
  2. 在重启过程中发送请求，验证错误响应
  3. 内部API重启完成后，再次发送请求
- **预期结果**：
  - 内部API重启过程中，代理服务器返回错误信息
  - 内部API重启完成后，代理服务器能够正常处理请求

## 10. 日志和监控测试

### 10.1 错误日志记录
- **测试目的**：验证代理服务器是否记录错误日志
- **测试方法**：触发代理服务器错误，检查日志
- **预期结果**：
  - 错误事件被记录到日志中
  - 日志包含错误时间、类型和详细信息

### 10.2 请求监控
- **测试目的**：验证代理服务器的请求监控能力
- **测试方法**：发送多个请求，检查监控数据
- **预期结果**：
  - 能够监控请求数量、响应时间和错误率
  - 监控数据准确反映实际请求情况
