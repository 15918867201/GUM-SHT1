# API功能测试用例

## 1. 功能测试

### 1.1 基本请求功能验证
- **测试目的**：验证API能够正确处理标准请求并返回预期数据
- **请求方法**：POST
- **请求URL**：`https://apolonia-seminomadic-yvone.ngrok-free.dev/api/huacore.forms/documentapi/getvalue`
- **请求头**：
  ```
  Content-Type: application/json
  ngrok-skip-browser-warning: 1
  ```
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200,  // 2024-01-01 00:00:00
    "end_datetime": 1704153599    // 2024-01-01 23:59:59
  }
  ```
- **预期结果**：
  - HTTP状态码：200
  - 返回JSON数组，包含多个数据点
  - 每个数据点包含以下字段：UAUTC, SXSRS, CEMGT, EGRMT, MATXT
  - 数据点按时间顺序排列
  - 数值类型字段为数字格式
  - 时间字段为有效日期字符串

### 1.2 时间范围参数测试

#### 1.2.1 短时间范围（1小时）
- **测试目的**：验证API能够处理短时间范围的精细数据查询
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200,  // 2024-01-01 00:00:00
    "end_datetime": 1704070799    // 2024-01-01 00:59:59
  }
  ```
- **预期结果**：
  - 返回该小时内的所有数据点
  - 数据点间隔均匀（如1秒或5秒）
  - 无重复数据

#### 1.2.2 中等时间范围（24小时）
- **测试目的**：验证API能够处理典型的日查询
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200,  // 2024-01-01 00:00:00
    "end_datetime": 1704153599    // 2024-01-01 23:59:59
  }
  ```
- **预期结果**：
  - 返回24小时内的所有数据点
  - 数据完整性良好
  - 响应时间在可接受范围内

#### 1.2.3 长时间范围（7天）
- **测试目的**：验证API能够处理长时间范围的批量数据查询
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200,  // 2024-01-01 00:00:00
    "end_datetime": 1704671999    // 2024-01-08 00:59:59
  }
  ```
- **预期结果**：
  - 返回7天内的数据点
  - 响应时间 < 5秒
  - 数据量合理（无过度采样）

#### 1.2.4 实时数据查询
- **测试目的**：验证API能够返回最新的实时数据
- **测试方法**：
  1. 获取当前时间戳
  2. 设置结束时间为当前时间
  3. 设置开始时间为当前时间前10分钟
- **预期结果**：
  - 返回最近10分钟的数据
  - 包含最新的实时数据点
  - 数据延迟 < 1分钟

### 1.3 数据格式验证
- **测试目的**：确保API返回的数据格式符合规范
- **测试方法**：
  1. 发送API请求
  2. 验证返回数据的格式和类型
- **预期结果**：
  - UAUTC：字符串类型，有效日期格式（如"2024-01-01T00:00:00Z"）
  - SXSRS：数字类型，范围在0-180之间
  - CEMGT：数字类型，范围在0-180之间
  - EGRMT：数字类型，范围在0-180之间
  - MATXT：字符串类型，产品型号信息

### 1.4 特殊数据点验证
- **测试目的**：验证API对特殊数据点的处理
- **测试方法**：
  1. 查找包含停机状态的数据范围（SXSRS=0）
  2. 查找包含峰值速度的数据范围（SXSRS接近180）
- **预期结果**：
  - 停机状态数据正确标识（SXSRS=0）
  - 峰值速度数据合理（不超过180）
  - 特殊状态下其他参数（如温度）数据正常

## 2. 边界情况测试

### 2.1 空时间范围
- **测试目的**：验证开始时间等于结束时间的情况
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200,
    "end_datetime": 1704067200
  }
  ```
- **预期结果**：
  - 返回空数组或包含该时间点的单个数据点
  - HTTP状态码：200
  - 无错误信息

### 2.2 开始时间大于结束时间
- **测试目的**：验证API对时间范围参数顺序错误的处理
- **请求体**：
  ```json
  {
    "start_datetime": 1704153599,
    "end_datetime": 1704067200
  }
  ```
- **预期结果**：
  - 返回400 Bad Request
  - 包含清晰的错误信息，如"开始时间不能大于结束时间"

### 2.3 超出范围的时间戳
- **测试目的**：验证API对极端时间范围的处理
- **请求体**：
  ```json
  {
    "start_datetime": 0,             // 1970-01-01
    "end_datetime": 1000000000000    // 2286-11-20
  }
  ```
- **预期结果**：
  - 返回有效时间范围内的数据点
  - 不返回超出实际数据范围的数据
  - HTTP状态码：200

### 2.4 未来时间查询
- **测试目的**：验证API对未来时间的处理
- **请求体**：
  ```json
  {
    "start_datetime": 1735689600,    // 2025-01-01
    "end_datetime": 1735775999      // 2025-01-01
  }
  ```
- **预期结果**：
  - 返回空数组
  - HTTP状态码：200
  - 无错误信息

### 2.5 数据缺失的时间范围
- **测试目的**：验证API对没有数据的时间范围的处理
- **请求体**：
  ```json
  {
    "start_datetime": 1000000000,    // 1973-03-03
    "end_datetime": 1000086399      // 1973-03-04
  }
  ```
- **预期结果**：
  - 返回空数组
  - HTTP状态码：200
  - 无错误信息

### 2.6 极大时间范围
- **测试目的**：验证API对非常大的时间范围的处理能力
- **请求体**：
  ```json
  {
    "start_datetime": 1609459200,    // 2021-01-01
    "end_datetime": 1735689600      // 2025-01-01
  }
  ```
- **预期结果**：
  - 成功返回所有数据点
  - 响应时间在可接受范围内
  - 数据量合理（可能进行采样处理）

### 2.7 边界时间点测试
- **测试目的**：验证API对边界时间点的精确处理
- **测试方法**：
  1. 发送包含已知数据点边界的请求
  2. 验证边界数据点是否被正确包含
- **预期结果**：
  - 边界时间点的数据被正确包含在响应中
  - 无重复或遗漏的数据点

## 3. 错误处理测试

### 3.1 缺少必要参数

#### 3.1.1 缺少开始时间
- **测试目的**：验证API对缺少开始时间参数的处理
- **请求体**：
  ```json
  {
    "end_datetime": 1704153599
  }
  ```
- **预期结果**：
  - 返回400 Bad Request
  - 错误信息清晰，如"缺少必要参数：start_datetime"

#### 3.1.2 缺少结束时间
- **测试目的**：验证API对缺少结束时间参数的处理
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200
  }
  ```
- **预期结果**：
  - 返回400 Bad Request
  - 错误信息清晰，如"缺少必要参数：end_datetime"

#### 3.1.3 完全空请求体
- **测试目的**：验证API对空请求体的处理
- **请求体**：`{}`
- **预期结果**：
  - 返回400 Bad Request
  - 错误信息清晰，如"缺少必要参数：start_datetime和end_datetime"

### 3.2 无效参数格式

#### 3.2.1 无效时间戳格式
- **测试目的**：验证API对非数字时间戳的处理
- **请求体**：
  ```json
  {
    "start_datetime": "invalid",
    "end_datetime": 1704153599
  }
  ```
- **预期结果**：
  - 返回400 Bad Request
  - 错误信息清晰，如"时间戳格式无效"

#### 3.2.2 字符串数字时间戳
- **测试目的**：验证API对字符串格式数字的处理
- **请求体**：
  ```json
  {
    "start_datetime": "1704067200",
    "end_datetime": "1704153599"
  }
  ```
- **预期结果**：
  - 成功处理，返回200状态码
  - 正确解析字符串为数字

#### 3.2.3 浮点数时间戳
- **测试目的**：验证API对浮点数时间戳的处理
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200.123,
    "end_datetime": 1704153599.456
  }
  ```
- **预期结果**：
  - 成功处理，返回200状态码
  - 正确解析浮点数为整数时间戳

### 3.3 无效请求格式

#### 3.3.1 无效JSON格式
- **测试目的**：验证API对语法错误JSON的处理
- **请求体**：（缺少闭合引号）
  ```
  {
    "start_datetime": 1704067200,
    "end_datetime": 1704153599
  ```
- **预期结果**：
  - 返回400 Bad Request
  - 错误信息清晰，如"请求体JSON格式无效"

#### 3.3.2 错误的Content-Type
- **测试目的**：验证API对错误Content-Type的处理
- **请求头**：`Content-Type: text/plain`
- **请求体**：
  ```json
  {
    "start_datetime": 1704067200,
    "end_datetime": 1704153599
  }
  ```
- **预期结果**：
  - 返回415 Unsupported Media Type
  - 错误信息清晰，如"不支持的Content-Type，仅支持application/json"

### 3.4 不支持的HTTP方法
- **测试目的**：验证API对不支持HTTP方法的处理
- **测试方法**：使用GET方法发送请求
- **预期结果**：
  - 返回405 Method Not Allowed
  - 错误信息清晰，如"不支持GET方法，仅支持POST和OPTIONS"

### 3.5 内部服务器错误模拟
- **测试目的**：验证API在内部服务器错误时的处理
- **测试方法**：通过代理服务器模拟内部API错误
- **预期结果**：
  - 返回500 Internal Server Error
  - 错误信息不泄露内部服务器详情
  - 前端能够优雅处理错误

## 4. 代理服务器测试

### 4.1 CORS配置验证
- **测试目的**：确保代理服务器正确设置CORS头，允许前端访问
- **测试方法**：
  1. 从不同域名（如localhost、GitHub Pages）发送请求
  2. 检查响应头中的CORS相关字段
  3. 测试OPTIONS预检请求
- **预期结果**：
  - Access-Control-Allow-Origin: *
  - Access-Control-Allow-Methods: GET, POST, OPTIONS
  - Access-Control-Allow-Headers: Content-Type
  - OPTIONS请求返回200状态码

### 4.2 请求转发准确性测试
- **测试目的**：验证代理服务器能够正确转发请求到内部API
- **测试方法**：
  1. 直接请求内部API获取基准数据
  2. 通过代理服务器请求相同数据
  3. 比较两种方式的响应数据
- **预期结果**：
  - 两种方式返回的数据完全一致
  - 响应状态码相同
  - 响应头（除CORS相关）相同

### 4.3 代理错误处理测试
- **测试目的**：验证代理服务器在内部API不可用时的错误处理
- **测试方法**：
  1. 暂时关闭内部API服务器
  2. 通过代理服务器发送请求
  3. 检查代理服务器的响应
- **预期结果**：
  - 返回适当的错误状态码（如503 Service Unavailable）
  - 错误信息清晰，不泄露内部服务器详情
  - 前端能够优雅处理错误

### 4.4 代理性能测试
- **测试目的**：验证代理服务器对请求响应时间的影响
- **测试方法**：
  1. 测量直接请求内部API的响应时间
  2. 测量通过代理服务器请求的响应时间
  3. 比较两者的差异
- **预期结果**：
  - 代理服务器增加的响应时间 < 100ms
  - 不显著影响整体API性能

### 4.5 代理请求格式验证
- **测试目的**：确保代理服务器正确处理各种请求格式
- **测试方法**：
  1. 发送不同内容类型的请求
  2. 测试不同大小的请求体
  3. 验证响应内容类型正确
- **预期结果**：
  - 支持application/json内容类型
  - 能够处理不同大小的请求体（1KB到1MB）
  - 响应内容类型与内部API一致

## 5. 前端集成测试

### 5.1 时间选择组件
- **测试目的**：验证时间选择组件能够正确发送请求
- **测试步骤**：
  1. 选择"最近1小时"按钮
  2. 检查API请求是否包含正确的时间戳
- **预期结果**：API请求的时间范围为当前时间前1小时

### 5.2 图表渲染测试
- **测试目的**：验证图表能够正确渲染API返回的数据
- **测试步骤**：
  1. 发送API请求获取数据
  2. 检查图表是否显示正确的数据点
- **预期结果**：图表显示的数据与API返回的数据一致

### 5.3 停机时间计算测试
- **测试目的**：验证停机时间计算功能
- **测试步骤**：
  1. 发送API请求获取包含停机数据的响应
  2. 检查停机时间表格是否显示正确的停机时间段和持续时间
- **预期结果**：停机时间计算准确，表格显示正确

## 6. 性能测试

### 6.1 API响应时间基准测试
- **测试目的**：测量API在正常负载下的响应时间百分位
- **测试方法**：
  1. 发送100次连续请求
  2. 记录每次请求的响应时间
  3. 计算50th, 90th, 95th, 99th百分位响应时间
- **预期结果**：
  - 50th百分位 < 500ms
  - 90th百分位 < 1秒
  - 95th百分位 < 1.5秒
  - 99th百分位 < 2秒

### 6.2 不同数据量响应时间测试
- **测试目的**：验证不同时间范围对响应时间的影响
- **测试方法**：
  1. 请求1小时数据（约3600个数据点）
  2. 请求24小时数据（约86400个数据点）
  3. 请求7天数据（约604800个数据点）
- **预期结果**：
  - 响应时间与数据量成线性关系
  - 7天数据响应时间 < 5秒

### 6.3 负载测试（逐步增加并发）
- **测试目的**：确定API的最大并发处理能力
- **测试方法**：
  1. 从1个并发用户开始
  2. 每次增加10个用户，持续5分钟
  3. 记录不同并发下的响应时间和错误率
- **并发级别**：1, 10, 50, 100, 200, 500
- **预期结果**：
  - 100并发下，90th百分位响应时间 < 2秒
  - 错误率 < 1%
  - 确定API的最大稳定并发数

### 6.4 持续负载测试
- **测试目的**：验证API在长时间运行下的稳定性
- **测试方法**：
  1. 维持50个并发用户
  2. 持续运行24小时
  3. 监控响应时间、错误率和资源使用率
- **预期结果**：
  - 响应时间保持稳定（无明显增加）
  - 错误率 < 0.1%
  - 无内存泄漏

### 6.5 突发流量测试
- **测试目的**：验证API在突发流量下的处理能力
- **测试方法**：
  1. 稳定10个并发用户运行5分钟
  2. 突然增加到100个并发用户，持续1分钟
  3. 恢复到10个并发用户，观察恢复情况
- **预期结果**：
  - 突发期间错误率 < 5%
  - 恢复时间 < 30秒

### 6.6 资源消耗监控
- **测试目的**：监控API服务器在不同负载下的资源消耗
- **监控指标**：
  - CPU使用率
  - 内存使用率
  - 数据库连接数
  - 网络带宽使用率
- **预期结果**：
  - CPU使用率 < 70%
  - 内存使用率 < 80%
  - 数据库连接数在配置限制内

### 6.7 前端渲染性能测试
- **测试目的**：验证前端页面渲染性能
- **测试方法**：使用浏览器开发者工具测量页面加载和渲染时间
- **预期结果**：
  - 页面加载时间 < 2秒
  - 图表渲染时间 < 1秒
  - 首次内容绘制（FCP）< 1秒
  - 最大内容绘制（LCP）< 2秒

## 7. 安全测试

### 7.1 HTTPS传输验证
- **测试目的**：确保所有API通信都通过HTTPS加密
- **测试方法**：
  1. 尝试使用HTTP协议访问API
  2. 验证是否自动重定向到HTTPS
  3. 检查HTTPS证书的有效性和完整性
- **预期结果**：
  - HTTP请求自动重定向到HTTPS
  - HTTPS证书有效且未过期
  - 证书链完整

### 7.2 CORS配置测试
- **测试目的**：验证跨域资源共享配置的安全性
- **测试方法**：
  1. 从不同域名发送请求，检查CORS头
  2. 测试不允许的HTTP方法
  3. 测试不允许的请求头
- **预期结果**：
  - Access-Control-Allow-Origin正确配置
  - Access-Control-Allow-Methods仅包含必要的方法
  - Access-Control-Allow-Headers仅包含必要的头

### 7.3 请求速率限制测试
- **测试目的**：验证API是否有适当的速率限制机制
- **测试方法**：
  1. 短时间内发送大量请求（如100次/秒）
  2. 检查是否返回429 Too Many Requests状态码
  3. 测试正常速率下是否允许请求
- **预期结果**：
  - 超过速率限制时返回429状态码
  - 正常速率下请求被允许
  - 有明确的速率限制策略（如X-RateLimit-*头）

### 7.4 输入验证与注入防护
- **测试目的**：验证API对恶意输入的防护能力
- **SQL注入测试**：
  ```json
  {
    "start_datetime": "1704067200'; DROP TABLE users; --",
    "end_datetime": 1704153599
  }
  ```
- **XSS注入测试**：
  ```json
  {
    "start_datetime": 1704067200,
    "end_datetime": "1704153599<script>alert('XSS')</script>"
  }
  ```
- **命令注入测试**：
  ```json
  {
    "start_datetime": "1704067200; ls -la",
    "end_datetime": 1704153599
  }
  ```
- **预期结果**：
  - 所有恶意请求被拒绝或参数被正确转义
  - 不执行恶意代码
  - 返回适当的错误信息

### 7.5 敏感数据泄露测试
- **测试目的**：确保API不泄露敏感信息
- **测试方法**：
  1. 检查API响应中是否包含：
     - 数据库连接信息
     - 服务器路径信息
     - 内部IP地址
     - 错误堆栈信息
     - 认证凭证
  2. 测试错误场景下的响应
- **预期结果**：
  - 响应中不包含任何敏感信息
  - 错误信息不泄露系统内部细节

### 7.6 安全头测试
- **测试目的**：验证API响应中是否包含必要的安全头
- **测试方法**：检查响应头是否包含：
  - Content-Security-Policy
  - X-Content-Type-Options
  - X-Frame-Options
  - X-XSS-Protection
  - Strict-Transport-Security
- **预期结果**：
  - 包含必要的安全头
  - 安全头配置合理

### 7.7 授权与访问控制测试
- **测试目的**：验证API的访问控制机制
- **测试方法**：
  1. 尝试未授权访问API
  2. 测试权限提升尝试
  3. 验证资源级别的访问控制
- **预期结果**：
  - 未授权请求被拒绝
  - 权限提升尝试失败
  - 严格的资源访问控制

## 8. 可靠性测试

### 8.1 长时间运行测试
- **测试目的**：验证API长时间运行的稳定性
- **测试方法**：持续请求API 24小时
- **预期结果**：API能够稳定运行，没有内存泄漏或性能下降

### 8.2 网络异常测试
- **测试目的**：验证API对网络异常的处理
- **测试方法**：模拟网络中断、超时等异常情况
- **预期结果**：API能够优雅地处理网络异常，返回适当的错误信息

### 8.3 服务器重启测试
- **测试目的**：验证API服务器重启后的恢复能力
- **测试方法**：重启API服务器后，立即发送请求
- **预期结果**：API能够快速恢复正常服务
