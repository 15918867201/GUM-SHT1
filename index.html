<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>切片停机监控</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // 自动检测并强制使用 HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            location.replace(`https:${location.href.substring(location.protocol.length)}`);
        }
    </script>
</head>
<body>
    <!-- 标题 -->
    <div style="text-align: center; margin: 20px 0;">
        <h1 style="font-family: 'calibri', 'kaiti'; font-size: 32px; margin: 0;">切片停机监控</h1>
    </div>
    
    <!-- 消息显示 -->
    <div style="text-align:center; margin: 10px 0;">
        <span>-</span><span style="font-family: 'calibri', 'kaiti';" id="msgbox"></span><span>-</span>
    </div>
    
    <div style="margin: 20px 0;">        
        <!-- 时间段选择区域 - 居中显示 -->
        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <label for="startDateTime">开始日期：</label>
                <input type="datetime-local" id="startDateTime" style="padding: 5px; font-size: 14px;">
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <label for="endDateTime">结束日期：</label>
                <input type="datetime-local" id="endDateTime" style="padding: 5px; font-size: 14px;">
            </div>
            <button id="queryBtn" style="padding: 6px 15px; font-size: 14px; background-color: #0078D4; color: white; border: none; border-radius: 3px; cursor: pointer;">查询</button>
        </div>
        
        <!-- 快速选择按钮 - 居中显示 -->
        <style>
            /* 添加内联样式，确保按钮样式能够正确显示 */
            .quickSelectBtn {
                padding: 6px 15px !important;
                font-size: 14px !important;
                background-color: #f0f0f0 !important;
                border: 1px solid #ccc !important;
                border-radius: 3px !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            }
            
            .quickSelectBtn.active {
                background-color: #0078D4 !important;
                color: white !important;
                border-color: #0078D4 !important;
            }
        </style>
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
            <button class="quickSelectBtn" data-shift="晚班">晚班</button>
            <button class="quickSelectBtn" data-shift="早班">早班</button>
            <button class="quickSelectBtn" data-shift="中班">中班</button>
            <button class="quickSelectBtn" data-type="24h">最近24小时</button>
            
            <!-- 自动刷新开关 -->
            <label class="switch" style="margin-left: 20px; display: flex; align-items: center; gap: 5px;">
                <input id="isAuto" type="checkbox" checked />
                <span class="slider"></span>
                <span style="margin-left: 10px;">自动刷新</span>
            </label>
        </div>
    </div>
    
    <!-- 图表容器 -->
    <div style="height: 600px; width: 100%;">
        <canvas id="myChart"></canvas>
    </div>
    
    <!-- 产量统计表格 -->
    <div style="margin-top: 30px;">
        <h3 style="text-align: center; margin-bottom: 15px;">产量统计</h3>
        <div style="overflow-x: auto;">
            <table id="productionTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr style="background-color: #f2f2f2;">
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">日期</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">班次</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">香型</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">产量（批）</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">停机次数</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">停机时间汇总（分钟）</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 停机时间统计表格 -->
    <div style="margin-top: 30px;">
        <h3 style="text-align: center; margin-bottom: 15px;">停机时间统计</h3>
        <div style="overflow-x: auto;">
            <table id="downtimeTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr style="background-color: #f2f2f2;">
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">日期</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">班次</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">香型</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">开始时间</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">结束时间</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">停机时间（min）</th>
                        
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- div>
        <input id="numberBox" type="number" inputmode="numeric" pattern="[0-9]*" value="1" />
    </div -->
    <script>
        // 辅助函数：格式化日期时间为ISO格式（用于datetime-local输入框）
        function formatDateTimeForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // 辅助函数：将datetime-local输入框的值转换为时间戳
        function getTimestampFromInput(inputId) {
            const input = document.getElementById(inputId);
            if (!input.value) return null;
            return Math.floor(new Date(input.value).getTime() / 1000);
        }
        
        // 初始化默认时间范围（最近24小时）
        function initDateTimeInputs() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 1);
            
            document.getElementById('startDateTime').value = formatDateTimeForInput(startDate);
            document.getElementById('endDateTime').value = formatDateTimeForInput(endDate);
        }
        
        // 设置时间范围
        function setDateTimeRange(startDate, endDate) {
            document.getElementById('startDateTime').value = formatDateTimeForInput(startDate);
            document.getElementById('endDateTime').value = formatDateTimeForInput(endDate);
            // 直接调用RefreshChart，而不是refreshChartWithCustomRange，避免重置按钮样式
            const start_ts = Math.floor(startDate.getTime() / 1000);
            const end_ts = Math.floor(endDate.getTime() / 1000);
            RefreshChart(start_ts, end_ts);
        }
        
        // 快速选择按钮事件处理
        function handleQuickSelectClick(event) {
            const button = event.target;
            
            console.log('handleQuickSelectClick called');
            console.log('Clicked button:', button.textContent);
            
            // 重置所有按钮样式为非选中状态
            const allQuickBtns = document.querySelectorAll('.quickSelectBtn');
            allQuickBtns.forEach(btn => {
                // 直接修改样式
                btn.style.padding = '6px 15px';
                btn.style.fontSize = '14px';
                btn.style.backgroundColor = '#f0f0f0';
                btn.style.color = '#000000';
                btn.style.border = '1px solid #ccc';
                btn.style.borderRadius = '3px';
                btn.style.cursor = 'pointer';
                btn.style.transition = 'all 0.2s ease';
                btn.classList.remove('active');
                console.log('Reset style for button:', btn.textContent);
            });
            
            // 设置当前按钮样式为选中状态
            // 直接修改样式
            button.style.padding = '6px 15px';
            button.style.fontSize = '14px';
            button.style.backgroundColor = '#0078D4';
            button.style.color = '#ffffff';
            button.style.border = '1px solid #0078D4';
            button.style.borderRadius = '3px';
            button.style.cursor = 'pointer';
            button.style.transition = 'all 0.2s ease';
            button.classList.add('active');
            console.log('Set active style for button:', button.textContent);
            console.log('Button classes:', button.className);
            
            const now = new Date();
            let startDate = new Date();
            let endDate = new Date();
            
            if (button.dataset.shift) {
                // 按班次选择
                const shift = button.dataset.shift;
                const currentHour = now.getHours();
                
                if (shift === '晚班') {
                    // 晚班：0:00-8:00
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(8, 0, 0, 0);
                    
                    // 如果当前时间已经过了晚班时间，则选择昨天的晚班
                    if (currentHour >= 8) {
                        startDate.setDate(startDate.getDate() - 1);
                        endDate.setDate(endDate.getDate() - 1);
                    }
                } else if (shift === '早班') {
                    // 早班：8:00-16:00
                    startDate.setHours(8, 0, 0, 0);
                    endDate.setHours(16, 0, 0, 0);
                    
                    // 如果当前时间已经过了早班时间，则选择今天的早班
                    // 如果当前时间还没到早班时间，则选择昨天的早班
                    if (currentHour < 8) {
                        startDate.setDate(startDate.getDate() - 1);
                        endDate.setDate(endDate.getDate() - 1);
                    }
                } else if (shift === '中班') {
                    // 中班：16:00-24:00
                    startDate.setHours(16, 0, 0, 0);
                    endDate.setHours(23, 59, 59, 999);
                    
                    // 如果当前时间还没到中班时间，则选择昨天的中班
                    if (currentHour < 16) {
                        startDate.setDate(startDate.getDate() - 1);
                        endDate.setDate(endDate.getDate() - 1);
                    }
                }
            } else if (button.dataset.type === '24h') {
                // 最近24小时
                startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                endDate = now;
            }
            
            setDateTimeRange(startDate, endDate);
        }
        
        // 刷新图表（使用自定义时间范围）
        function refreshChartWithCustomRange() {
            // 获取自定义时间范围
            const start_ts = getTimestampFromInput('startDateTime');
            const end_ts = getTimestampFromInput('endDateTime');
            
            if (!start_ts || !end_ts) {
                console.error('Invalid date range');
                return;
            }
            
            // 当使用自定义时间段时，重置所有快速选择按钮样式为非选中状态
            const allQuickBtns = document.querySelectorAll('.quickSelectBtn');
            allQuickBtns.forEach(btn => {
                // 直接修改样式
                btn.style.padding = '6px 15px';
                btn.style.fontSize = '14px';
                btn.style.backgroundColor = '#f0f0f0';
                btn.style.color = '#000000';
                btn.style.border = '1px solid #ccc';
                btn.style.borderRadius = '3px';
                btn.style.cursor = 'pointer';
                btn.style.transition = 'all 0.2s ease';
                btn.classList.remove('active');
                console.log('Reset style for button:', btn.textContent);
            });
            
            // 调用刷新函数，传入自定义时间范围
            RefreshChart(start_ts, end_ts);
        }
        
        // 等待DOM完全加载后添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            
            // 初始化日期时间输入框
            initDateTimeInputs();
            
            // 添加查询按钮事件监听器
            document.getElementById("queryBtn").addEventListener("click", () => {
                console.log('Query button clicked');
                refreshChartWithCustomRange();
            });
            
            // 添加快速选择按钮事件监听器
            const quickSelectBtns = document.querySelectorAll('.quickSelectBtn');
            console.log('Found quick select buttons:', quickSelectBtns.length);
            quickSelectBtns.forEach(btn => {
                btn.addEventListener('click', handleQuickSelectClick);
                console.log('Added click listener to button:', btn.textContent);
            });
            
            // 设置默认选中按钮（最近24小时）的样式
            const defaultActiveBtn = document.querySelector('.quickSelectBtn.active');
            if (defaultActiveBtn) {
                // 直接修改样式
                defaultActiveBtn.style.padding = '6px 15px';
                defaultActiveBtn.style.fontSize = '14px';
                defaultActiveBtn.style.backgroundColor = '#0078D4';
                defaultActiveBtn.style.color = '#ffffff';
                defaultActiveBtn.style.border = '1px solid #0078D4';
                defaultActiveBtn.style.borderRadius = '3px';
                defaultActiveBtn.style.cursor = 'pointer';
                defaultActiveBtn.style.transition = 'all 0.2s ease';
                console.log('Set default active style for button:', defaultActiveBtn.textContent);
            }
        });
    </script>

    <!-- script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script -->
    <script src="chart.umd.min.js"></script>
    <script>
        Date.prototype.ISOFormat = function () {
            var sDate = this.toISOString().split("T")[0];
            var aTime = this.toISOString().split("T")[1].split(":");
            return sDate + "T" + aTime[0] + ":" + aTime[1] + "Z";
        }

        var MATXT = [];

        const header = (tooltipItems) => {
            /*
            let sum = 0;
            tooltipItems.forEach(function (tooltipItem) {
                // sum += tooltipItem.parsed.y;
            });
            */
            if (MATXT[tooltipItems[0].dataIndex]) {
                return '生产香型: ' + MATXT[tooltipItems[0].dataIndex];
            }
        };

        const ctx = document.getElementById('myChart');
        // const sheeting_ctx = document.getElementById('sheetingChart');
        
        // 添加默认数据，以便在API请求失败时图表仍然可以显示
        const defaultLabels = ['默认数据1', '默认数据2', '默认数据3', '默认数据4', '默认数据5'];
        const defaultData = [0, 0, 0, 0, 0];
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: defaultLabels,
                datasets: [
                    {
                        label: '切片整线速度',
                        data: defaultData,
                        borderColor: 'rgba(0,158,235,1)',
                        backgroundColor: 'rgba(0,158,235,0.5)',
                        yAxisID: 'y',
                        tension: 0.1 // 添加曲线平滑度
                    },
                    {
                        label: '挤压出口胶温度',
                        data: defaultData,
                        // borderColor: 'rgba(214,66,0,1)',
                        borderColor: 'rgba(227,0,115,1)',
                        backgroundColor: 'rgba(227,0,115,0.5)',
                        yAxisID: 'y1',
                        tension: 0.1 // 添加曲线平滑度
                    },
                    {
                        label: '冷辊入口胶温度',
                        data: defaultData,
                        borderColor: 'rgba(230,160,0,1)',
                        backgroundColor: 'rgba(230,160,0,0.5)',
                        yAxisID: 'y1',
                        tension: 0.1 // 添加曲线平滑度
                    }
                ],

            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // 允许图表调整大小
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        labels: {
                            font: {
                                size: 13,
                                family: "'calibri', 'kaiti'",
                            }
                        }
                    },
                    tooltip: {
                        titleFont: {
                            size: 14,
                            weight: "bold",
                            family: "'calibri', 'kaiti'",
                        },
                        bodyFont: {
                            size: 13,
                            family: "'calibri', 'kaiti'",
                        },
                        callbacks: {
                            afterTitle: (tooltipItems) => {
                                if (MATXT[tooltipItems[0].dataIndex]) {
                                    return MATXT[tooltipItems[0].dataIndex];
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 180,
                        ticks: {
                            beginAtZero: true,
                            stepSize: 10,
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        max: 180,
                        /* grid line settings
                        grid: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                        */
                        ticks: {
                            beginAtZero: true,
                            stepSize: 10,
                        },
                    },
                },
                elements: {
                    point: {
                        radius: 0, // 不显示数据点
                    },
                    line: {
                        borderWidth: 2 // 线条宽度
                    }
                }
            },
        });

        // 统计停机时间函数
        function calculateDowntime(times, speeds, flavors) {
            const downtimeList = [];
            let downtimeStart = null;
            let downtimeFlavor = null;
            
            for (let i = 0; i < speeds.length; i++) {
                if (speeds[i] === 0 && downtimeStart === null) {
                    downtimeStart = times[i];
                    downtimeFlavor = flavors[i] || 'Unknown';
                } else if (speeds[i] !== 0 && downtimeStart !== null) {
                    const downtimeEnd = times[i];
                    downtimeList.push({
                        start: downtimeStart,
                        end: downtimeEnd,
                        flavor: downtimeFlavor
                    });
                    downtimeStart = null;
                    downtimeFlavor = null;
                }
            }
            
            if (downtimeStart !== null) {
                const downtimeEnd = times[times.length - 1];
                downtimeList.push({
                    start: downtimeStart,
                    end: downtimeEnd,
                    flavor: downtimeFlavor
                });
            }
            
            updateDowntimeTable(downtimeList);
        }
        
        // 根据日期时间确定班次
        function getShiftFromDate(dateStr) {
            if (!dateStr || dateStr === '-') {
                return '-';
            }
            
            // 从日期字符串中提取时间部分
            const date = new Date(dateStr);
            const hour = date.getHours();
            
            if (hour >= 0 && hour < 8) {
                return '晚班';
            } else if (hour >= 8 && hour < 16) {
                return '早班';
            } else {
                return '中班';
            }
        }
        
        // 计算产量和停机信息
        function calculateProduction(times, speeds, flavors) {
            const productionByDate = {};
            
            for (let i = 0; i < speeds.length; i++) {
                const speed = speeds[i];
                const flavor = flavors[i] || 'Unknown';
                const time = times[i];
                
                // 确定日期和班次
                const dateObj = new Date(time);
                const date = dateObj.toLocaleDateString('zh-CN');
                const hour = dateObj.getHours();
                let shift = '';
                if (hour >= 0 && hour < 8) {
                    shift = '晚班';
                } else if (hour >= 8 && hour < 16) {
                    shift = '早班';
                } else {
                    shift = '中班';
                }
                
                // 初始化数据结构
                if (!productionByDate[date]) {
                    productionByDate[date] = {};
                }
                if (!productionByDate[date][shift]) {
                    productionByDate[date][shift] = {};
                }
                if (!productionByDate[date][shift][flavor]) {
                    productionByDate[date][shift][flavor] = {
                        production: 0,
                        downtimeCount: 0,
                        downtimeTime: 0
                    };
                }
                
                // 计算产量（速度不为0时）
                if (speed !== 0) {
                    const minuteProduction = speed * 0.392 / 562;
                    productionByDate[date][shift][flavor].production += minuteProduction;
                }
            }
            
            // 计算停机次数和停机时间
            let downtimeStart = null;
            let downtimeFlavor = null;
            
            for (let i = 0; i < speeds.length; i++) {
                const speed = speeds[i];
                const flavor = flavors[i] || 'Unknown';
                const time = times[i];
                
                // 确定日期和班次
                const dateObj = new Date(time);
                const date = dateObj.toLocaleDateString('zh-CN');
                const hour = dateObj.getHours();
                let shift = '';
                if (hour >= 0 && hour < 8) {
                    shift = '晚班';
                } else if (hour >= 8 && hour < 16) {
                    shift = '早班';
                } else {
                    shift = '中班';
                }
                
                // 检测停机开始
                if (speed === 0 && downtimeStart === null) {
                    downtimeStart = time;
                    downtimeFlavor = flavor;
                }
                // 检测停机结束
                else if (speed !== 0 && downtimeStart !== null) {
                    const downtimeEnd = time;
                    const downtimeDuration = (new Date(downtimeEnd) - new Date(downtimeStart)) / (1000 * 60);
                    
                    // 累加停机次数和停机时间
                    if (productionByDate[date] && productionByDate[date][shift] && productionByDate[date][shift][downtimeFlavor]) {
                        productionByDate[date][shift][downtimeFlavor].downtimeCount += 1;
                        productionByDate[date][shift][downtimeFlavor].downtimeTime += downtimeDuration;
                    }
                    
                    downtimeStart = null;
                    downtimeFlavor = null;
                }
            }
            
            // 处理最后一个停机事件
            if (downtimeStart !== null) {
                const downtimeEnd = times[times.length - 1];
                const downtimeDuration = (new Date(downtimeEnd) - new Date(downtimeStart)) / (1000 * 60);
                const dateObj = new Date(downtimeStart);
                const date = dateObj.toLocaleDateString('zh-CN');
                const hour = dateObj.getHours();
                let shift = '';
                if (hour >= 0 && hour < 8) {
                    shift = '晚班';
                } else if (hour >= 8 && hour < 16) {
                    shift = '早班';
                } else {
                    shift = '中班';
                }
                
                if (productionByDate[date] && productionByDate[date][shift] && productionByDate[date][shift][downtimeFlavor]) {
                    productionByDate[date][shift][downtimeFlavor].downtimeCount += 1;
                    productionByDate[date][shift][downtimeFlavor].downtimeTime += downtimeDuration;
                }
            }
            
            return productionByDate;
        }
        
        // 检测当前模式（自动/手动）
        function detectMode(customStartTs, customEndTs) {
            // 如果有自定义时间范围，则为手动模式
            if (customStartTs !== null && customEndTs !== null) {
                return 'manual';
            }
            
            // 检查是否有快速选择按钮被选中
            const activeQuickBtn = document.querySelector('.quickSelectBtn.active');
            if (activeQuickBtn) {
                // 如果选中的是"最近24小时"，则为自动模式
                if (activeQuickBtn.dataset.type === '24h') {
                    return 'auto';
                }
                // 否则为手动模式（班次选择）
                return 'manual';
            }
            
            // 默认为自动模式
            return 'auto';
        }
        
        // 更新产量统计表格
        function updateProductionTable(productionByDate, mode, autoModeProduction = null) {
            const tableBody = document.querySelector('#productionTable tbody');
            
            tableBody.innerHTML = '';
            
            const dates = Object.keys(productionByDate);
            if (dates.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                return;
            }
            
            // 按日期排序
            dates.sort();
            
            dates.forEach(date => {
                const shifts = Object.keys(productionByDate[date]);
                // 按班次排序：晚班、早班、中班
                const shiftOrder = ['晚班', '早班', '中班'];
                shifts.sort((a, b) => shiftOrder.indexOf(a) - shiftOrder.indexOf(b));
                
                shifts.forEach(shift => {
                    const flavors = Object.keys(productionByDate[date][shift]);
                    flavors.forEach(flavor => {
                        const data = productionByDate[date][shift][flavor];
                        
                        if (flavor === 'Unknown' || data.production <= 0) {
                            return;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="border: 1px solid #ddd; padding: 8px;">${date}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${shift}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${flavor}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${data.production.toFixed(2)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${data.downtimeCount}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${data.downtimeTime.toFixed(1)}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                });
            });
        }
        
        // 更新停机时间表格
        function updateDowntimeTable(downtimeList) {
            const tableBody = document.querySelector('#downtimeTable tbody');
            
            tableBody.innerHTML = '';
            
            if (downtimeList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                return;
            }
            
            downtimeList.forEach(downtime => {
                const startTime = new Date(downtime.start);
                const endTime = new Date(downtime.end);
                const durationMs = endTime - startTime;
                const durationMins = Math.round((durationMs / (1000 * 60)) * 10) / 10;
                
                const date = startTime.toLocaleDateString('zh-CN');
                const startTimeStr = startTime.toTimeString().split(' ')[0];
                const endTimeStr = endTime.toTimeString().split(' ')[0];
                
                const hour = startTime.getHours();
                let shift = '';
                if (hour >= 0 && hour < 8) {
                    shift = '晚班';
                } else if (hour >= 8 && hour < 16) {
                    shift = '早班';
                } else {
                    shift = '中班';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${date}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${shift}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${downtime.flavor || 'Unknown'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${startTimeStr}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${endTimeStr}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${durationMins}分钟</td>                    
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        var RefreshChart = (customStartTs = null, customEndTs = null) => {
            // 检查是否需要跳过刷新（仅在自动刷新模式下）
            if (!document.getElementById("isAuto").checked && !customStartTs && !customEndTs) {
                return;
            }

            MATXT = [];
            var UAUTC = [];
            var SXSRS = [];
            var CEMGT = [];
            var EGRMT = [];

            var dtNow = new Date();
            var end_ts = customEndTs || Math.floor(dtNow.getTime()/1000);
            var start_ts = customStartTs || end_ts - 60*60*24;
            
            console.log('RefreshChart called');
            console.log('Start time:', new Date(start_ts * 1000).toLocaleString());
            console.log('End time:', new Date(end_ts * 1000).toLocaleString());
            
            // 检查是否使用默认的24小时时间范围
            if (!customStartTs && !customEndTs) {
                console.log('Using default 24h time range, updating quick select buttons');
                
                // 重置所有快速选择按钮样式
                const allQuickBtns = document.querySelectorAll('.quickSelectBtn');
                allQuickBtns.forEach(btn => {
                    btn.style.backgroundColor = '#f0f0f0';
                    btn.style.color = '#000000';
                    btn.style.border = '1px solid #ccc';
                    btn.classList.remove('active');
                });
                
                // 激活'最近24小时'按钮
                const last24hBtn = document.querySelector('.quickSelectBtn[data-type="24h"]');
                if (last24hBtn) {
                    last24hBtn.style.backgroundColor = '#0078D4';
                    last24hBtn.style.color = '#ffffff';
                    last24hBtn.style.border = '1px solid #0078D4';
                    last24hBtn.classList.add('active');
                    console.log('Activated "最近24小时" button');
                }
            }
            
            // 使用代理服务器请求真实API数据，解决CORS问题
            // 优先尝试使用uniCloud云函数（如果可用），否则使用本地代理服务器
            const useUniCloud = false; // 设置为true以使用uniCloud云函数
            
            if (useUniCloud && typeof uni !== 'undefined' && typeof uniCloud !== 'undefined') {
                console.log('Using uniCloud cloud function for API request');
                
                // 使用uniCloud云函数调用
                uniCloud.callFunction({
                    name: 'api-proxy',
                    data: { 
                        start_datetime: start_ts, 
                        end_datetime: end_ts,
                        httpMethod: 'POST'
                    },
                    success: (res) => {
                        console.log('uniCloud function response:', res);
                        const json = res.result.data;
                        processApiResponse(json, customStartTs, customEndTs);
                    },
                    fail: (err) => {
                        console.error('uniCloud function call failed:', err);
                        document.getElementById("msgbox").innerText = 'Error: ' + err.errMsg;
                        updateDowntimeTable([]);
                        const productionTableBody = document.querySelector('#productionTable tbody');
                        productionTableBody.innerHTML = '<tr><td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                    }
                });
            } else {
                // 使用Ngrok内网穿透后的公网URL
                const url = `https://apolonia-seminomadic-yvone.ngrok-free.dev/api/huacore.forms/documentapi/getvalue?t=${new Date().getTime()}`;
                console.log('API URL via Ngrok:', url);
                
                fetch(url, { 
                    method: "POST", 
                    headers: { 
                        "Content-Type": "application/json"
                    }, 
                    body: JSON.stringify({ "start_datetime": start_ts, "end_datetime": end_ts }) 
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    if (!response.ok) {
                        throw new Error(`Http error! status: ${response.status}`);
                    }
                    return response.json().catch(() => response.text());
                })
                .then(json => {
                    console.log('Raw response data:', json);
                    console.log('Response data type:', typeof json);
                    // 尝试处理不同的响应格式
                    if (typeof json === 'object' && json !== null) {
                        if (Array.isArray(json)) {
                            processApiResponse(json, customStartTs, customEndTs);
                        } else if (json.data) {
                            console.log('Using data field from response');
                            if (Array.isArray(json.data)) {
                                processApiResponse(json.data, customStartTs, customEndTs);
                            } else if (typeof json.data === 'object') {
                                processApiResponse([json.data], customStartTs, customEndTs);
                            } else {
                                console.error('Unexpected data format:', json.data);
                                document.getElementById("msgbox").innerText = 'Error: Unexpected data format';
                                updateDowntimeTable([]);
                                const productionTableBody = document.querySelector('#productionTable tbody');
                                productionTableBody.innerHTML = '<tr><td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                            }
                        } else if (json.rows) {
                            console.log('Using rows field from response');
                            processApiResponse(json.rows, customStartTs, customEndTs);
                        } else {
                            console.error('No data or rows field found in response');
                            document.getElementById("msgbox").innerText = 'Error: No data field found';
                            updateDowntimeTable([]);
                            const productionTableBody = document.querySelector('#productionTable tbody');
                            productionTableBody.innerHTML = '<tr><td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                        }
                    } else {
                        console.error('Invalid response format:', json);
                        document.getElementById("msgbox").innerText = 'Error: Invalid response format';
                        updateDowntimeTable([]);
                        const productionTableBody = document.querySelector('#productionTable tbody');
                        productionTableBody.innerHTML = '<tr><td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    console.error('Error type:', typeof error);
                    console.error('Error stack:', error.stack);
                    document.getElementById("msgbox").innerText = 'Error: ' + (error.message || 'Network error');
                    updateDowntimeTable([]);
                    const productionTableBody = document.querySelector('#productionTable tbody');
                    productionTableBody.innerHTML = '<tr><td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                });
            }
        };
        
        // 处理API响应数据
        function processApiResponse(json, customStartTs = null, customEndTs = null) {
            console.log('API response data:', json);
            console.log('Data type:', typeof json);
            
            // 确保json是数组
            if (!Array.isArray(json)) {
                console.error('Expected array but got:', json);
                document.getElementById("msgbox").innerText = 'Error: Invalid data format';
                updateDowntimeTable([]);
                return;
            }
            
            console.log('Data length:', json.length);
            document.getElementById("msgbox").innerText = json.length;
            
            // 如果没有数据，保持当前图表不变
            if (json.length === 0) {
                console.log('No data returned from API');
                // 清空停机表格
                updateDowntimeTable([]);
                // 清空产量统计表格
                const productionTableBody = document.querySelector('#productionTable tbody');
                productionTableBody.innerHTML = '<tr><td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                return;
            }
            
            // 检查第一个元素的结构
            console.log('First element structure:', json[0]);
            
            // 清空现有数据数组
            UAUTC = [];
            SXSRS = [];
            CEMGT = [];
            EGRMT = [];
            MATXT = [];
            
            json.forEach((element, index) => {
                try {
                    // 检查必要字段
                    console.log(`Element ${index} fields:`, Object.keys(element));
                    
                    var dt = new Date(element["UAUTC"] || element["timestamp"]);
                    var rs = element["SXSRS"] ? element["SXSRS"] / 1.2 : 0;
                    var gt = element["CEMGT"] ? element["CEMGT"] : 0;
                    var et = element["EGRMT"] ? element["EGRMT"] : 0;
                    if (gt <= 30 || et <= 38) { rs = 0; }
                    
                    UAUTC.push(dt.toLocaleString());
                    SXSRS.push(Number(rs.toFixed(1)));
                    CEMGT.push(Number(gt.toFixed(2)));
                    EGRMT.push(Number(et.toFixed(2)));
                    MATXT.push(element["MATXT"] || 'Unknown');
                } catch (error) {
                    console.error(`Error processing element ${index}:`, error);
                    console.error(`Element ${index}:`, element);
                }
            });
            
            // 检查是否有有效数据
            if (UAUTC.length === 0) {
                console.error('No valid data processed');
                document.getElementById("msgbox").innerText = 'Error: No valid data processed';
                updateDowntimeTable([]);
                return;
            }
            
            console.log('Processed data:');
            console.log('Labels:', UAUTC);
            console.log('SXSRS data:', SXSRS);
            console.log('EGRMT data:', EGRMT);
            console.log('CEMGT data:', CEMGT);
            
            chart.data.labels = UAUTC;
            chart.data.datasets[0].data = SXSRS;
            chart.data.datasets[1].data = EGRMT;
            chart.data.datasets[2].data = CEMGT;
            chart.update();
            
            calculateDowntime(UAUTC, SXSRS, MATXT);
            
            // 计算产量并更新产量统计表格
            const productionByDate = calculateProduction(UAUTC, SXSRS, MATXT);
            const mode = detectMode(customStartTs, customEndTs);
            updateProductionTable(productionByDate, mode);
            
            console.log('Chart updated successfully with real API data');
        }
        // Initiate Chart
        RefreshChart();
        //
        setInterval(RefreshChart, 45000)
    </script>
</body>
</html>
